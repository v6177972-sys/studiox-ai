import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithPopup, 
  GoogleAuthProvider, 
  onAuthStateChanged, 
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  onSnapshot, 
  setDoc, 
  updateDoc, 
  getDoc,
  increment,
  arrayUnion // Per aggiungere elementi all'archivio
} from 'firebase/firestore';
import { 
  Share2, 
  Zap, 
  PlayCircle, 
  LogIn, 
  LogOut, 
  Copy, 
  PlusCircle, 
  LayoutGrid,
  Image, // Nuova icona per l'immagine
  History,
  Sparkles,
  Loader2 // Icona per il caricamento
} from 'lucide-react';

// --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'studiox-pro-v4';

// --- CONFIGURAZIONE GOOGLE GEMINI (Placeholder) ---
// DOVRAI SOSTITUIRE QUESTO CON LA TUA VERA API KEY DI GEMINI
const GEMINI_API_KEY = typeof __gemini_api_key !== 'undefined' ? __gemini_api_key : 'AIzaSyA-t4HPU63sjwlxGaHOR3__08cLJRRqyLs';
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${AIzaSyA-t4HPU63sjwlxGaHOR3__08cLJRRqyLs}`;
const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-001:generateImages?key=${AIzaSyA-t4HPU63sjwlxGaHOR3__08cLJRRqyLs}`; // Esempio per Imagen

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState({ nrg: 20, archive: [] });
  const [showStore, setShowStore] = useState(false);
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState(null);
  const [prompt, setPrompt] = useState('');
  const [visualMode, setVisualMode] = useState(false); // Nuovo stato per testo+immagine
  const [result, setResult] = useState({ text: null, imageUrl: null }); // Risultato generazione

  // 1. GESTIONE STATO E PERSISTENZA
  useEffect(() => {
    const localNrg = localStorage.getItem('studiox_temp_nrg');
    if (localNrg && !user) {
      setUserData(prev => ({ ...prev, nrg: parseInt(localNrg) }));
    }

    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile');
        const unsubData = onSnapshot(userRef, (snap) => {
          if (snap.exists()) {
            setUserData(snap.data());
          } else {
            const currentNrg = parseInt(localStorage.getItem('studiox_temp_nrg')) || 20;
            setDoc(userRef, { 
              nrg: currentNrg + 50, 
              archive: [], 
              email: currentUser.email 
            });
            localStorage.removeItem('studiox_temp_nrg');
          }
        });
        return () => unsubData();
      }
    });
    return () => unsubscribeAuth();
  }, [user]);

  useEffect(() => {
    if (!user) {
      localStorage.setItem('studiox_temp_nrg', userData.nrg);
    }
  }, [userData.nrg, user]);

  const showMsg = (text) => {
    setToast(text);
    setTimeout(() => setToast(null), 3000);
  };

  // 2. AZIONI CORE
  const handleLogin = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      showMsg("Cloud Sincronizzato!");
    } catch (err) {
      showMsg("Errore Accesso Google");
    }
  };

  const generateContent = async () => {
    if (!prompt.trim()) {
      showMsg("Scrivi un'idea per il post!");
      return;
    }

    const cost = visualMode ? 10 : 2;
    if (userData.nrg < cost) {
      setShowStore(true);
      showMsg("Energia Esaurita!");
      return;
    }

    setLoading(true);
    setResult({ text: null, imageUrl: null }); // Azzera il risultato precedente

    let generatedText = "Contenuto AI generato: " + prompt; // Placeholder per testo
    let generatedImageUrl = null; // Placeholder per immagine

    try {
      // Simulazione o chiamata API Gemini per il testo
      const textResponse = await fetch(GEMINI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Genera un post social in italiano di massimo 100 parole sul tema: "${prompt}"` }] }]
        })
      });
      const textData = await textResponse.json();
      if (textData.candidates && textData.candidates[0] && textData.candidates[0].content && textData.candidates[0].content.parts[0]) {
        generatedText = textData.candidates[0].content.parts[0].text;
      } else {
        generatedText = "Contenuto di esempio per: " + prompt; // Fallback se API Gemini non risponde
      }

      // Generazione immagine se visualMode è attivo
      if (visualMode) {
        const imageResponse = await fetch(IMAGEN_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `Genera un'immagine stilizzata e accattivante per un post social sul tema: "${prompt}"`,
            // Altri parametri Imagen, es. aspect_ratio, number_of_images
          })
        });
        const imageData = await imageResponse.json();
        if (imageData.images && imageData.images[0] && imageData.images[0].url) {
          generatedImageUrl = imageData.images[0].url;
        } else {
          // Fallback: immagine di default se API Imagen non risponde
          generatedImageUrl = 'https://via.placeholder.com/400x200?text=Immagine+IA+qui'; 
        }
      }

      setResult({ text: generatedText, imageUrl: generatedImageUrl });

      // Aggiorna crediti e archivio
      const newNrg = userData.nrg - cost;
      if (user) {
        const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
        await updateDoc(userRef, { 
          nrg: newNrg,
          archive: arrayUnion({ 
            text: generatedText, 
            imageUrl: generatedImageUrl, 
            timestamp: new Date().toISOString() 
          })
        });
      } else {
        setUserData(prev => ({ 
          ...prev, 
          nrg: newNrg,
          archive: [...prev.archive, { text: generatedText, imageUrl: generatedImageUrl, timestamp: new Date().toISOString() }]
        }));
      }
      showMsg("Contenuto AI generato!");

    } catch (error) {
      console.error("Errore durante la generazione:", error);
      showMsg("Errore nella generazione AI. Riprova!");
    } finally {
      setLoading(false);
    }
  };

  const handleReward = async (amount) => {
    const newNrg = userData.nrg + amount;
    if (user) {
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile');
      await updateDoc(userRef, { nrg: increment(amount) });
    } else {
      setUserData(prev => ({ ...prev, nrg: newNrg }));
    }
    showMsg(`+${amount} N-RG Ricevuti!`);
    setShowStore(false); // Chiudi store dopo il reward
  };

  return (
    <div className="min-h-screen bg-[#050505] text-white font-sans selection:bg-purple-500/30">
      
      {/* BANNER PUBBLICITARIO SUPERIORE */}
      <div className="w-full h-12 bg-zinc-900/50 border-b border-white/5 flex items-center justify-center text-[8px] tracking-[0.4em] text-zinc-600 font-bold">
        ADSENSE BANNER TOP
      </div>

      <header className="sticky top-0 z-40 bg-black/80 backdrop-blur-xl border-b border-white/5 p-4 flex justify-between items-center">
        <div className="flex flex-col">
          <span className="text-xs font-black tracking-tighter italic font-serif">STUDIOX.PRO</span>
          <span className="text-[6px] text-purple-500 font-bold uppercase tracking-widest">
            {user ? 'Cloud Account' : 'Guest Mode'}
          </span>
        </div>

        <div className="flex items-center gap-3">
          <div 
            onClick={() => setShowStore(true)}
            className="bg-zinc-900 border border-purple-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 cursor-pointer active:scale-90 transition-all"
          >
            <Zap size={10} className="text-yellow-400 fill-yellow-400" />
            <span className="text-[10px] font-black">{userData.nrg}</span>
          </div>
          
          {user ? (
            <button onClick={() => signOut(auth)} className="opacity-30 hover:opacity-100">
              <LogOut size={12} />
            </button>
          ) : (
            <button 
              onClick={handleLogin}
              className="bg-white/10 text-white border border-white/10 px-3 py-1.5 rounded-full text-[9px] font-black"
            >
              SALVA PROGRESSI
            </button>
          )}
        </div>
      </header>

      <main className="p-6 max-w-2xl mx-auto space-y-8">
        
        {/* INVITO AL LOGIN SE GUEST E CREDITI BASSI */}
        {!user && userData.nrg < 10 && (
          <div className="bg-gradient-to-r from-purple-900/40 to-blue-900/40 p-4 rounded-3xl border border-white/10 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="bg-white/10 p-2 rounded-full"><Sparkles size={16} className="text-yellow-400" /></div>
              <div className="flex flex-col">
                <span className="text-[10px] font-black uppercase">Bonus Benvenuto</span>
                <span className="text-[8px] opacity-60">Accedi per +50 N-RG Gratis</span>
              </div>
            </div>
            <button onClick={handleLogin} className="bg-white text-black text-[9px] font-black px-4 py-2 rounded-xl uppercase">Accedi</button>
          </div>
        )}

        <div className="space-y-6">
          <div className="bg-zinc-900/50 rounded-[2.5rem] p-6 border border-white/5 shadow-2xl">
            <textarea 
              className="w-full bg-transparent border-none focus:ring-0 text-lg placeholder:text-zinc-700 resize-none min-h-[120px]"
              placeholder="Cosa vuoi pubblicare oggi?"
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
            ></textarea>
            <div className="flex justify-between items-center mt-6 pt-6 border-t border-white/5">
              <div className="flex gap-2">
                <button 
                  onClick={() => setVisualMode(!visualMode)}
                  className={`p-3 rounded-2xl transition-colors ${visualMode ? 'bg-purple-600/40 text-purple-300' : 'bg-white/5 text-white/50 hover:bg-white/10'}`}
                >
                  <Image size={14}/>
                </button>
                <button className="p-3 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors text-white/50"><LayoutGrid size={14}/></button> {/* Tono */}
                <button className="p-3 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors text-white/50"><Share2 size={14}/></button> {/* Condividi */}
              </div>
              <button 
                onClick={generateContent}
                disabled={loading}
                className="bg-purple-600 px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-900/20 active:scale-95 transition-all flex items-center gap-2"
              >
                {loading ? <Loader2 size={14} className="animate-spin" /> : null}
                {loading ? 'Generando...' : `Genera (${visualMode ? '10' : '2'} N-RG)`}
              </button>
            </div>
          </div>

          {/* AREA RISULTATO GENERAZIONE */}
          {(result.text || result.imageUrl) && (
            <div className="bg-zinc-900/50 rounded-[2.5rem] p-6 border border-white/5 shadow-2xl space-y-4">
              <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-600">Ultimo Post IA</h3>
              {result.imageUrl && (
                <img src={result.imageUrl} alt="Contenuto IA" className="w-full rounded-2xl object-cover aspect-video border border-white/10" />
              )}
              {result.text && (
                <div className="relative group">
                  <p className="text-zinc-300 italic leading-relaxed whitespace-pre-wrap">{result.text}</p>
                  <button 
                    onClick={() => { navigator.clipboard.writeText(result.text); showMsg("Testo copiato!"); }}
                    className="absolute top-2 right-2 p-2 bg-white/10 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <Copy size={14} className="text-white/70" />
                  </button>
                </div>
              )}
            </div>
          )}

          {/* QUICK ACTIONS REWARDS */}
          <div className="grid grid-cols-2 gap-3">
            <div 
              onClick={() => handleReward(10)}
              className="bg-zinc-900/80 p-5 rounded-3xl border border-white/5 flex flex-col items-center gap-2 cursor-pointer hover:bg-zinc-800 transition-all"
            >
              <PlayCircle size={18} className="text-green-400" />
              <span className="text-[9px] font-black uppercase">Reward Video</span>
              <span className="text-[7px] text-green-400 font-bold">+10 N-RG</span>
            </div>
            <div 
              onClick={() => handleReward(5)}
              className="bg-zinc-900/80 p-5 rounded-3xl border border-white/5 flex flex-col items-center gap-2 cursor-pointer hover:bg-zinc-800 transition-all"
            >
              <Share2 size={18} className="text-blue-400" />
              <span className="text-[9px] font-black uppercase">Condividi App</span>
              <span className="text-[7px] text-blue-400 font-bold">+5 N-RG</span>
            </div>
          </div>

          {/* HISTORY */}
          <div className="space-y-4">
              <div className="flex items-center gap-2 px-2">
                <History size={12} className="text-zinc-600" />
                <span className="text-[9px] font-black uppercase tracking-[0.2em] text-zinc-600">I Tuoi Ultimi Post</span>
              </div>
              <div className="bg-zinc-900/30 rounded-3xl p-4 border border-white/5 italic text-zinc-500 text-[10px] text-center">
                {userData.archive && userData.archive.length > 0 ? (
                    <div className="space-y-2">
                        {userData.archive.slice(-3).reverse().map((item, index) => (
                            <div key={index} className="flex items-center justify-between bg-white/5 p-2 rounded-xl">
                                <span className="truncate w-4/5 text-white/80">{item.text}</span>
                                {item.imageUrl && <Image size={12} className="text-purple-400 flex-shrink-0" />}
                            </div>
                        ))}
                    </div>
                ) : (
                    "I post generati appariranno qui."
                )}
              </div>
            </div>
        </div>
      </main>

      {/* STORE MODAL */}
      {showStore && (
        <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6">
          <div className="max-w-xs w-full space-y-8">
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-black italic tracking-tighter">ENERGIA FINITA</h2>
              <p className="text-[9px] text-zinc-500 uppercase tracking-widest italic">Scegli come ricaricare</p>
            </div>

            <div className="space-y-3">
              <div onClick={() => { setShowStore(false); handleLogin(); }} className="bg-white text-black p-6 rounded-[2.5rem] flex flex-col items-center gap-2 cursor-pointer">
                <span className="text-[10px] font-black uppercase">Accedi con Google</span>
                <span className="text-[14px] font-black">+50 N-RG GRATIS</span>
              </div>
              
              <div onClick={() => handleReward(10)} className="bg-zinc-900 p-6 rounded-[2.5rem] border border-white/10 flex flex-col items-center gap-2 cursor-pointer">
                <PlayCircle className="text-purple-500" />
                <span className="text-[10px] font-black uppercase">Guarda uno Sponsor</span>
                <span className="text-[8px] text-purple-400">+10 N-RG</span>
              </div>
            </div>

            <button onClick={() => setShowStore(false)} className="w-full text-[8px] font-bold text-zinc-600 uppercase tracking-widest">Forse più tardi</button>
          </div>
        </div>
      )}

      {/* TOAST MESSAGES */}
      {toast && (
        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] bg-white text-black px-6 py-3 rounded-full flex items-center gap-3 shadow-2xl animate-bounce">
          <Zap size={14} className="fill-yellow-500 text-yellow-500" />
          <span className="text-[10px] font-black uppercase tracking-widest">{toast}</span>
        </div>
      )}

      {/* BANNER PUBBLICITARIO INFERIORE */}
      <div className="fixed bottom-0 w-full h-16 bg-black border-t border-white/5 flex items-center justify-center text-[7px] text-zinc-700 tracking-[0.5em] font-bold">
        ADSENSE BANNER BOTTOM
      </div>

    </div>
  );
}

