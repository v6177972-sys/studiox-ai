<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioX AI | Monetizzazione Attiva</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #050505; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }
        .ui-card { background: #111114; border: 1px solid #1f1f23; border-radius: 2rem; }
        .btn-main { background: linear-gradient(135deg, #6366f1, #a855f7); }
        .nrg-glow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); }
        .shimmer { background: linear-gradient(90deg, #111, #1a1a1e, #111); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .loader-spin { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FB_INSTANCE = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, arrayUnion };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const APP_ID = "studiox-v6-core";
        // Ho cambiato il modello in gemini-1.5-flash per maggiore stabilit√†
        const MODEL = "gemini-1.5-flash"; 
        const API_KEY = "AIzaSyA-t4HPU63sjwlxGaHOR3__08cLJRRqyLs";

        function App() {
            const [user, setUser] = useState(null);
            const [data, setData] = useState({ nrg: 0 });
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState("");
            const [toast, setToast] = useState("");

            useEffect(() => {
                const config = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (!config.apiKey) return;

                const app = window.FB_INSTANCE.initializeApp(config);
                const auth = window.FB_INSTANCE.getAuth(app);
                const db = window.FB_INSTANCE.getFirestore(app);

                window.FB_INSTANCE.onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        const docRef = window.FB_INSTANCE.doc(db, 'artifacts', APP_ID, 'users', u.uid, 'profile');
                        window.FB_INSTANCE.onSnapshot(docRef, (snap) => {
                            if (snap.exists()) setData(snap.data());
                            else window.FB_INSTANCE.setDoc(docRef, { nrg: 30, history: [] });
                        });
                    } else {
                        window.FB_INSTANCE.signInAnonymously(auth);
                    }
                });
            }, []);

            const notify = (msg) => { setToast(msg); setTimeout(() => setToast(""), 3000); };

            const handleGenerate = async () => {
                if (!input.trim()) return notify("Inserisci un'idea!");
                if (data.nrg < 5) return notify("Energia esaurita!");
                
                setLoading(true);
                setResult("");

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Sei un esperto di social media. Crea un post virale per Instagram con emoji e 15 hashtag per: ${input}` }] }]
                        })
                    });

                    const resData = await response.json();
                    
                    if (resData.error) {
                        throw new Error(resData.error.message);
                    }

                    const outputText = resData.candidates[0].content.parts[0].text;
                    setResult(outputText);

                    const db = window.FB_INSTANCE.getFirestore();
                    const docRef = window.FB_INSTANCE.doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile');
                    await window.FB_INSTANCE.updateDoc(docRef, {
                        nrg: window.FB_INSTANCE.increment(-5),
                        history: window.FB_INSTANCE.arrayUnion({ date: new Date().toISOString(), input, outputText })
                    });

                    notify("Generato! -5 ‚ö°");
                } catch (e) {
                    console.error(e);
                    notify("Errore API: Quota superata o Chiave invalida");
                } finally {
                    setLoading(false);
                }
            };

            const addNrg = async () => {
                if (!user) return;
                const db = window.FB_INSTANCE.getFirestore();
                const docRef = window.FB_INSTANCE.doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile');
                await window.FB_INSTANCE.updateDoc(docRef, { nrg: window.FB_INSTANCE.increment(10) });
                notify("+10 Energia! (Simulazione Ad)");
                // Qui puoi aprire un link pubblicitario reale:
                window.open("https://www.google.com", "_blank");
            };

            const openAffiliate = () => {
                // Sostituisci questo link con il tuo link Amazon o Canva Affiliato
                window.open("https://www.canva.com/pro/", "_blank");
            };

            return (
                <div className="min-h-screen max-w-md mx-auto p-5 flex flex-col gap-6 bg-[#050505] pb-24 border-x border-zinc-900">
                    
                    <header className="flex justify-between items-center py-4">
                        <h1 className="text-2xl font-black tracking-tighter italic">STUDIOX<span className="text-purple-500">AI</span></h1>
                        <div className="nrg-glow bg-zinc-900 px-4 py-2 rounded-2xl flex items-center gap-2">
                            <span className="text-purple-400 font-bold">‚ö°</span>
                            <span className="text-sm font-black tracking-tighter">{data.nrg}</span>
                        </div>
                    </header>

                    {/* TASTO AFFILIAZIONE ATTIVO */}
                    <div 
                        onClick={openAffiliate}
                        className="ui-card p-4 border-purple-500/20 bg-purple-500/5 flex items-center justify-between cursor-pointer active:scale-95 transition-all"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">üíé</span>
                            <div>
                                <p className="text-[10px] font-black text-purple-400 uppercase">Offerta Esclusiva</p>
                                <p className="text-xs font-bold text-zinc-300">Ottieni Canva Pro per i tuoi post</p>
                            </div>
                        </div>
                        <span className="text-zinc-600">‚Üí</span>
                    </div>

                    {/* EDITOR */}
                    <div className="ui-card p-6 space-y-4 shadow-2xl">
                        <textarea 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Descrivi il tuo post (es. Una foto di un gatto)..."
                            className="w-full bg-transparent border-none focus:ring-0 text-lg h-32 resize-none text-white placeholder:text-zinc-800"
                        />
                        <button 
                            onClick={handleGenerate}
                            disabled={loading}
                            className="w-full btn-main py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 text-white shadow-lg"
                        >
                            {loading ? <div className="loader-spin"></div> : "‚ú®"}
                            {loading ? "Generazione..." : "Crea Post Virale"}
                        </button>
                    </div>

                    {/* RISULTATO */}
                    {result && (
                        <div className="ui-card p-6 border-purple-500/20 animate-in fade-in slide-in-from-bottom-4">
                            <div className="flex justify-between items-center mb-4 border-b border-zinc-800 pb-2">
                                <span className="text-[9px] font-black text-purple-400 uppercase tracking-widest">Risultato AI</span>
                                <button onClick={() => {navigator.clipboard.writeText(result); notify("Copiato!");}} className="text-[10px] font-bold text-zinc-600">COPIA</button>
                            </div>
                            <div className="text-sm text-zinc-300 leading-relaxed whitespace-pre-wrap">
                                {result}
                            </div>
                        </div>
                    )}

                    {/* TASTO PUBBLICIT√Ä ATTIVO */}
                    <div 
                        onClick={addNrg}
                        className="ui-card p-5 flex items-center justify-between cursor-pointer active:bg-zinc-900 border-green-500/10"
                    >
                        <div className="flex items-center gap-4">
                            <span className="text-2xl">üéÅ</span>
                            <div>
                                <p className="text-[10px] font-black text-white uppercase tracking-wider">Bonus Energia</p>
                                <p className="text-[9px] text-zinc-500 font-bold">Apri Sponsor per +10 ‚ö°</p>
                            </div>
                        </div>
                        <span className="text-green-500 font-black text-xs">+10</span>
                    </div>

                    {/* BANNER PUBBLICITARIO (Simulazione) */}
                    <div className="shimmer w-full h-24 rounded-[2.5rem] border border-zinc-800 flex items-center justify-center cursor-pointer" onClick={() => window.open('https://www.google.com', '_blank')}>
                        <p className="text-[8px] font-bold text-zinc-600 uppercase tracking-[0.5em]">Advertising Space Active</p>
                    </div>

                    {/* TOAST */}
                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white text-black px-8 py-3 rounded-full shadow-2xl z-[100] text-[9px] font-black uppercase tracking-widest animate-bounce">
                            {toast}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

